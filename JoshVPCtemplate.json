{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template to create a VPC named JoshVPC",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Description": "The environment for my VPC."
    },
    "Stack": {
      "Type": "String",
      "Description": "The Stack for my VPC."
    }
  },
  "Resources": {
    "JoshBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "Private"
      }
    },
    "JoshProjectVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.68.0.0/18",
        "EnableDnsSupport": true,
        "EnableDnsHostnames": true,
        "InstanceTenancy": "default",
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ "JoshVPC", { "Ref": "Environment" }, { "Ref": "Stack" } ] ] } }
        ]
      }
    },
    "JoshPublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "JoshProjectVPC" },
        "CidrBlock": "10.68.0.0/24",
        "AvailabilityZone": "eu-west-1a",
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ "JoshPublicSubnet1", { "Ref": "Environment" }, { "Ref": "Stack" } ] ] } }
        ]
      }
    },
    "JoshPublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "JoshProjectVPC" },
        "CidrBlock": "10.68.1.0/24",
        "AvailabilityZone": "eu-west-1b",
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ "JoshPublicSubnet2", { "Ref": "Environment" }, { "Ref": "Stack" } ] ] } }
        ]
      }
    },
    "JoshPrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "JoshProjectVPC" },
        "CidrBlock": "10.68.2.0/24",
        "AvailabilityZone": "eu-west-1a",
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ "JoshPrivateSubnet1", { "Ref": "Environment" }, { "Ref": "Stack" } ] ] } }
        ]
      }
    },
    "JoshPrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "JoshProjectVPC" },
        "CidrBlock": "10.68.3.0/24",
        "AvailabilityZone": "eu-west-1b",
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ "JoshPrivateSubnet2", { "Ref": "Environment" }, { "Ref": "Stack" } ] ] } }
        ]
      }
    },
    "JoshInternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ { "Key" : "name", "Value" : { "Fn::Join" : [ "-", [ "JoshInternetGateway", { "Ref" : "Environment" }, { "Ref" : "Stack" } ] ] } } ]
      }
    },
    "JoshInternetGatewayAttachment" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "JoshProjectVPC" },
        "InternetGatewayId" : { "Ref" : "JoshInternetGateway" }
      }
    },
    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
        "Properties" : {
          "VpcId" : { "Ref" : "JoshProjectVPC" },
          "Tags" : [ { "Key" : "name", "Value" : { "Fn::Join" : [ "-", [ "JoshPublicRouteTable", { "Ref" : "Environment" }, { "Ref" : "Stack" } ] ] } } ]
        }
    },
    "PublicRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "JoshInternetGatewayAttachment",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0", 
        "GatewayId" : { "Ref" : "JoshInternetGateway" }
      }
    },
    "PublicSubnet1RouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "JoshPublicSubnet1" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },
    "PublicSubnet2RouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "JoshPublicSubnet2" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },
    "PrivateRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
        "Properties" : {
          "VpcId" : { "Ref" : "JoshProjectVPC" },
          "Tags" : [ { "Key" : "name", "Value" : { "Fn::Join" : [ "-", [ "JoshPrivateRouteTable", { "Ref" : "Environment" }, { "Ref" : "Stack" } ] ] } } ]
        }
    },
    "PrivateRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "JoshNatGateway",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Ref" : "JoshNatGateway" }
      }
    },
    "PrivateSubnet1RouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "JoshPrivateSubnet1" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable" }
      }
    },
    "PrivateSubnet2RouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "JoshPrivateSubnet2" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable" }
      }
    },
    "JoshNatGateway" : {
      "Type" : "AWS::EC2::NatGateway",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : [ "JoshNatGatewayEIP", "AllocationId" ] },
        "SubnetId" : { "Ref" : "JoshPublicSubnet1" },
        "Tags" : [ { "Key" : "name", "Value" : { "Fn::Join" : [ "-", [ "JoshNatGateway", { "Ref" : "Environment" }, { "Ref" : "Stack" } ] ] } } ]
      }
    },
    "JoshNatGatewayEIP" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : {
        "Domain" : "vpc",
        "Tags" : [ { "Key" : "name", "Value" : { "Fn::Join" : [ "-", [ "JoshNatGatewayEIP", { "Ref" : "Environment" }, { "Ref" : "Stack" } ] ] } } ]
      }
    },
    "LambdaBasicRole":{
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
          "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ],
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "MaxSessionDuration": 3600,
        "Path" : "/",
        "RoleName": "lambda-base-role"
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Lambda inside VPC",
        "VpcId": { "Ref": "JoshProjectVPC" },
        "SecurityGroupEgress": [
          { "IpProtocol": "-1", "CidrIp": "0.0.0.0/0" }
        ],
        "SecurityGroupIngress": [],
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": ["-", ["LambdaSG", {"Ref": "Environment"}, {"Ref": "Stack"}]] } }
        ]
      }
    },
    "HelloLambdaFunction": {
      "Type": "AWS::Lambda::Function",
      "DependsOn": ["LambdaBasicRole", "LambdaSecurityGroup"],
      "Properties": {
        "FunctionName": "HelloLambdaFunction",
        "Runtime": "python3.8",
        "Handler": "index.lambda_handler",
        "Code": {
          "ZipFile": "def lambda_handler(event, context):\n    return {'statusCode': 200, 'body': 'Hello from Lambda!'}"
        },
        "Role": {
          "Fn::GetAtt": ["LambdaBasicRole", "Arn"]
        },
        "Timeout": 10,
        "VpcConfig": {
          "SecurityGroupIds": [
            { "Ref": "LambdaSecurityGroup" }
          ],
          "SubnetIds": [
            { "Ref": "JoshPrivateSubnet1" },
            { "Ref": "JoshPrivateSubnet2" }
          ]
        }
      }
    },
    "JoshAPIGateway": {
      "Type": "AWS::ApiGateway::RestApi",
      "Properties": {
        "Name": "JoshAPIGateway"
      }
    },
    "HelloResource": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "RestApiId": { "Ref": "JoshAPIGateway" },
        "ParentId": { "Fn::GetAtt": ["JoshAPIGateway", "RootResourceId"] },
        "PathPart": "hello"
      }
    },
    "HelloGetMethod": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "RestApiId": { "Ref": "JoshAPIGateway" },
        "ResourceId": { "Ref": "HelloResource" },
        "HttpMethod": "GET",
        "AuthorizationType": "NONE",
        "Integration": {
          "Type": "AWS_PROXY",
          "IntegrationHttpMethod": "POST",
          "Uri": {
            "Fn::Sub": [
              "arn:aws:apigateway:${Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations",
              {
                "LambdaArn": { "Fn::GetAtt": ["HelloLambdaFunction", "Arn"] }
              }
            ]
          }
        }
      }
    },
    "HelloLambdaApiPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": { "Fn::GetAtt": ["HelloLambdaFunction", "Arn"] },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": { "Fn::Sub": ["arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${JoshApiGateway}/*/GET/hello",
        {"ApiId" : { "Ref": "JoshAPIGateway" }}] }
      }
    },
    "JoshApiDeployment": {
      "Type": "AWS::ApiGateway::Deployment",
      "DependsOn": ["HelloGetMethod", "HelloLambdaApiPermission"],
      "Properties": {
        "RestApiId": { "Ref": "JoshAPIGateway" },
        "StageName": "prod",
        "Description": {
        "Fn::Join": ["", ["Deployment-", { "Ref": "HelloGetMethod" }]]
        }
      }
    }
  },
    "Outputs": {
      "VPCId": {
        "Description": "The VPC ID",
        "Value": { "Ref": "JoshProjectVPC" }
      },
      "APIGatewayURL": {
        "Description": "The URL of the API Gateway",
        "Value": { "Fn::Sub": "https://${JoshAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/prod/hello" }
      }
    }
}

