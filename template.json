{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template to create a VPC named JoshVPC and IAM role for GitHub-triggered CloudFormation (improved)",
  "Parameters": {
    "VpcCidr": {
      "Type": "String",
      "Default": "10.68.0.0/18",
      "Description": "CIDR block for the VPC"
    }
  },
  "Resources": {
    "MyBucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Retain",
      "Properties": {
        "AccessControl": "Private",
        "Tags": [
          { "Key": "Name", "Value": "JoshCloudFormationBucket" }
        ]
      }
    },
    "JoshVPC": {
      "Type": "AWS::EC2::VPC",
      "DeletionPolicy": "Retain",
      "Properties": {
        "CidrBlock": { "Ref": "VpcCidr" },
        "EnableDnsSupport": true,
        "EnableDnsHostnames": true,
        "Tags": [
          { "Key": "Name", "Value": "JoshVPC" }
        ]
      }
    },
    "CloudFormationSyncRole": {
      "Type": "AWS::IAM::Role",
      "DeletionPolicy": "Retain",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": ["codestar-connections.amazonaws.com"] },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CloudFormationVPCSyncPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "SyncToCloudFormation",
                  "Effect": "Allow",
                  "Action": [
                    "ec2:CreateVpc",
                    "ec2:DeleteVpc",
                    "ec2:CreateRouteTable",
                    "ec2:AssociateRouteTable",
                    "cloudformation:CreateChangeSet",
                    "cloudformation:DeleteChangeSet",
                    "cloudformation:DescribeChangeSet",
                    "cloudformation:DescribeStackEvents",
                    "cloudformation:DescribeStacks",
                    "cloudformation:ExecuteChangeSet",
                    "cloudformation:GetTemplate",
                    "cloudformation:ListChangeSets",
                    "cloudformation:ListStacks",
                    "cloudformation:ValidateTemplate"
                  ],
                  "Resource": "*"
                },
                {
                  "Sid": "PolicyForManagedRules",
                  "Effect": "Allow",
                  "Action": ["events:PutRule", "events:PutTargets"],
                  "Resource": "*",
                  "Condition": {
                    "StringEquals": {
                      "events:ManagedBy": [
                        "cloudformation.sync.codestar-connections.amazonaws.com"
                      ]
                    }
                  }
                },
                {
                  "Sid": "PolicyForDescribingRule",
                  "Effect": "Allow",
                  "Action": "events:DescribeRule",
                  "Resource": "*"
                },
                {
                  "Sid": "VPCAccess",
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeVpcs",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeRouteTables",
                    "ec2:CreateSubnet",
                    "ec2:CreateRoute",
                    "ec2:AttachInternetGateway",
                    "ec2:CreateInternetGateway",
                    "ec2:ModifyVpcAttribute",
                    "ec2:CreateTags"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    }
  }
}
